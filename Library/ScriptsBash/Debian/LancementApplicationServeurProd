#!/bin/bash
#Ce script permet de lancer une application sur le serveur. Il récupère l'application dans la fonction de /SafeWorkSpace/Application/nomAppli/nomFonction 
#Paramètre 1: nom du créateur, Paramètre 2: nom de l'utilisateur, Paramètre 3: nom de l'application, Parmaètre 4: num de la version, Paramètre 5: nom de la fonction, Paramètre 6: les paramètres à envoyer à la fonction. 
#Chaques paramètres devra être séparé par le caractère "§" 
#Exemple: ./lancem John TailleArtere TailleParoi "img.jpg§2§1,2,3"
#Il copiera la fonction TailleParoi de /SafeWorkSpace/Application/TailleArtere/1.0.0/TailleParoi.php vers /SafeWorkSpace/Utilisateurs/John/TailleParoi.php
#Il copiera également tous les fichiers présent dans les datas de l'utilisateur vers le même dossier, dans cet exemple, /files/data/John/img.jpg vers /SafeWorkSpace/Utilisateurs/John/img.jpg

#Le paramètre $7 symbolise le choix de la version de python

#Texte d'explication du fonctionnement de docker ???

homenoolibco="/home/noolibco"
paramsModifier="";
fonctionLancer="";
timeout=15s;
usrPath=$homenoolibco/SafeWorkSpace/Utilisateurs/$2;
dockerPath="/home/noolibco/Library/ScriptsBash/Debian/docker-run-timeout";
if [ -f $homenoolibco/Files/Sources/$1/$3/$4/$5 ]; then
	cp $homenoolibco/Files/Sources/$1/$3/$4/$5 $homenoolibco/SafeWorkSpace/Utilisateurs/$2/$5;
	fichier=$5;
	extension=${fichier##*.}
	if [ $extension = "py" ]
	then
		version=3; #Remplacer par $7
		if [ $version = 3 ]
		then
			fonctionLancer=$dockerPath" 15s -v $usrPath:/app -w /app noolibco/python:3-alpine python3 "$fichier;
		elif [ $version = 2 ]
		then
			fonctionLancer=$dockerPath" 15s -v $usrPath:/app -w /app noolibco/python:2-apline python "$fichier;
		else
			echo "Python version $fichier not supported"
		fi
	elif [ $extension = "m" ]
	then
		fonctionLancer=$dockerPath" 15s -v $usrPath:/app -w /app numgeom/matlab-desktop:R2016b /usr/local/bin/start_matlab -nodesktop -nojvm -r "$fichier;
	elif [ $extension = "jar" ]
	then
		fonctionLancer=$dockerPath" 15s -v $usrPath:/app -w /app openjdk:alpine java -jar "$fichier;
	elif [ $extension = "php" ]
	then
		fonctionLancer=$dockerPath" 15s -v $usrPath:/app -w /app php:alpine php "$fichier;
	elif [ $extension = "js" ]
	then
		fonctionLancer=$dockerPath" 15s -v $usrPath:/app -w /app node:alpine node "$fichier;
	else
		echo "File extension $extension not supported"
	fi
	if [ $# -eq 6 ]
	then
		params=$(echo $6 | tr "§" "\n");
		for param in $params
		do
		    if [ -f $homenoolibco"/Files/Data/"$2"/"$param ];
		        then
		                cp $homenoolibco"/Files/Data/"$2"/"$param $homenoolibco/SafeWorkSpace/Utilisateurs/$2;
			fi
			paramsModifier=$paramsModifier" "$param;
		done
	fi
$fonctionLancer $paramsModifier;
#EOF
fi

